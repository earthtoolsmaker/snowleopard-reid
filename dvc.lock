schema: '2.0'
stages:
  reorganize_locations:
    cmd: uv run python scripts/data/reorganize_locations.py --input-dir 
      data/01_raw/locations --output-dir data/02_processed/locations 
      --config-dir data/02_processed/config
    deps:
    - path: data/01_raw/locations
      hash: md5
      md5: edba822bc576a007bfae675441ad4b56.dir
      size: 2887614689
      nfiles: 1315
    - path: data/02_processed/config/naryn/individuals.yaml
      hash: md5
      md5: 14868258fbcbc109256dc105357f9cd6
      size: 261
    - path: data/02_processed/config/naryn/mappings.yaml
      hash: md5
      md5: e49a170cf13814fcd616a03021aefb85
      size: 330
    - path: data/02_processed/config/sarychat/individuals.yaml
      hash: md5
      md5: 125eff4a1ad2befd7c48a64b0d9299fe
      size: 553
    - path: data/02_processed/config/sarychat/mappings.yaml
      hash: md5
      md5: 8a2adbbb8b46a78e096fad652963ac98
      size: 884
    - path: scripts/data/reorganize_locations.py
      hash: md5
      md5: 5ea198f09c96c54dc9c391f1b9ba7dcc
      size: 14960
    outs:
    - path: data/02_processed/locations
      hash: md5
      md5: 082552e9df22ae9e4786d9b65be68ea0.dir
      size: 1936317980
      nfiles: 909
  grounding_dino_detection:
    cmd: uv run python scripts/models/grounding_dino.py --input-dir 
      data/02_processed/locations --output-dir 
      data/05_model_output/grounding_dino --text-prompt "a snow leopard." 
      --model-id IDEA-Research/grounding-dino-base --box-threshold 0.30 
      --text-threshold 0.20
    deps:
    - path: data/02_processed/locations
      hash: md5
      md5: 082552e9df22ae9e4786d9b65be68ea0.dir
      size: 1936317980
      nfiles: 909
    - path: scripts/models/grounding_dino.py
      hash: md5
      md5: 5424263ead9d5765cefa17ca3336ce96
      size: 15400
    outs:
    - path: data/05_model_output/grounding_dino
      hash: md5
      md5: 49e4b24a348f63bc7a93a9832d5f9de6.dir
      size: 310549219
      nfiles: 1816
  sam_hq_segmentation:
    cmd: uv run python scripts/models/sam_hq.py --input-dir 
      data/02_processed/locations --predictions-dir 
      data/05_model_output/grounding_dino/predictions --output-dir 
      data/05_model_output/sam_hq --checkpoint 
      data/04_models/SAM_HQ/sam_hq_vit_l.pth --model-type vit_l
    deps:
    - path: data/02_processed/locations
      hash: md5
      md5: 082552e9df22ae9e4786d9b65be68ea0.dir
      size: 1936317980
      nfiles: 909
    - path: data/04_models/SAM_HQ/sam_hq_vit_l.pth
      hash: md5
      md5: 08947267966e4264fb39523eccc33f86
      size: 1254865805
    - path: data/05_model_output/grounding_dino
      hash: md5
      md5: 49e4b24a348f63bc7a93a9832d5f9de6.dir
      size: 310549219
      nfiles: 1816
    - path: scripts/models/sam_hq.py
      hash: md5
      md5: d434be67c9fd2774623e4d557186e936
      size: 16531
    outs:
    - path: data/05_model_output/sam_hq
      hash: md5
      md5: 0733a9d015aaa6f5e717969df6e874c4.dir
      size: 320102750
      nfiles: 2753
  crop_masks:
    cmd: uv run python scripts/data/crop_leopard_masks.py --sam-output-dir 
      data/05_model_output/sam_hq --output-dir 
      data/02_processed/cropped/leopards --padding 10
    deps:
    - path: data/05_model_output/sam_hq
      hash: md5
      md5: 0733a9d015aaa6f5e717969df6e874c4.dir
      size: 320102750
      nfiles: 2753
    - path: scripts/data/crop_leopard_masks.py
      hash: md5
      md5: ff7ab3b01b1003062b09750dda67817e
      size: 7054
    outs:
    - path: data/02_processed/cropped/leopards
      hash: md5
      md5: d4444cdb7522271639b33213f4e1537a.dir
      size: 235758260
      nfiles: 934
  yolo_prepare_dataset:
    cmd: uv run python scripts/data/sam_to_yolo.py --sam-output-dir 
      ./data/05_model_output/sam_hq --yolo-output-dir 
      ./data/02_processed/yolo/segmentation --min-area 200 --max-size 1024
    deps:
    - path: ./data/05_model_output/sam_hq
      hash: md5
      md5: 0733a9d015aaa6f5e717969df6e874c4.dir
      size: 320102750
      nfiles: 2753
    - path: ./scripts/data/sam_to_yolo.py
      hash: md5
      md5: 58d5a05f26bfcd2955da23626c97677f
      size: 19874
    outs:
    - path: ./data/02_processed/yolo/segmentation
      hash: md5
      md5: f506e8b9d97e889c551e494dfa0b7442.dir
      size: 631347266
      nfiles: 2724
  split_yolo_dataset:
    cmd: uv run python scripts/data/split_yolo_dataset.py --input-curated-json 
      ./data/02_processed/fiftyone/yolo/segmentation/fiftyone_curated_selection.json
      --output-dir ./data/03_model_input/yolo/segmentation --random-seed 42 
      --train-ratio 0.8 --val-ratio 0.1 --test-ratio 0.1
    deps:
    - path: 
        ./data/02_processed/fiftyone/yolo/segmentation/fiftyone_curated_selection.json
      hash: md5
      md5: 73f49a0c042bf62bd08ae764c3ac3d75
      size: 108415
    - path: ./scripts/data/split_yolo_dataset.py
      hash: md5
      md5: 608950311ea41579710607d55232f64c
      size: 17929
    outs:
    - path: ./data/03_model_input/yolo/segmentation
      hash: md5
      md5: 47e1e795826544a973d7123440a20f10.dir
      size: 75410083
      nfiles: 464
  train_yolo_segmentation_baseline:
    cmd: uv run python scripts/models/train_yolo_segmentation.py --data-yaml 
      ./data/03_model_input/yolo/segmentation/data.yaml --output-dir 
      ./data/04_models/yolo/segmentation/baseline --model yolo11n-seg --epochs 
      10 --batch-size 32 --imgsz 640
    deps:
    - path: ./data/03_model_input/yolo/segmentation
      hash: md5
      md5: 0f2c503a1abb2ca993e41d927cfe23af.dir
      size: 77618832
      nfiles: 466
    - path: ./scripts/models/train_yolo_segmentation.py
      hash: md5
      md5: 12e391f2786992715cb7f4455097dbc4
      size: 10786
    outs:
    - path: ./data/04_models/yolo/segmentation/baseline
      hash: md5
      md5: a6df538710cba20d7097ded4a8ff47f4.dir
      size: 16243647
      nfiles: 23
  train_yolo_segmentation_best:
    cmd: uv run python scripts/models/train_yolo_segmentation.py --data-yaml 
      ./data/03_model_input/yolo/segmentation/data.yaml --output-dir 
      ./data/04_models/yolo/segmentation/best --model yolo11n-seg --epochs 30 
      --batch-size 16 --imgsz 1280 --fliplr 0.5 --scale 0.7 --translate 0.2 
      --lr0 0.02 --lrf 0.01 --warmup-epochs 5 --patience 50
    deps:
    - path: ./data/03_model_input/yolo/segmentation
      hash: md5
      md5: 0f2c503a1abb2ca993e41d927cfe23af.dir
      size: 77618832
      nfiles: 466
    - path: ./scripts/models/train_yolo_segmentation.py
      hash: md5
      md5: 52333d001efba74a28d96e8af14bb461
      size: 12350
    outs:
    - path: ./data/04_models/yolo/segmentation/best
      hash: md5
      md5: d1e32f521a72cbaa2b467e5b817aa430.dir
      size: 19780038
      nfiles: 28
  build_catalog:
    cmd: uv run python scripts/catalog/build_catalog_from_selection.py 
      --selection-file data/08_catalog/v1.0/selection.yaml --catalog-dir 
      data/08_catalog/v1.0/database && uv run python 
      scripts/catalog/extract_catalog_features.py --catalog-dir 
      data/08_catalog/v1.0/database --extractor sift --max-keypoints 2048 && uv 
      run python scripts/catalog/generate_catalog_metadata.py --catalog-dir 
      data/08_catalog/v1.0 --catalog-version 1.0.0
    deps:
    - path: data/02_processed/cropped/leopards
      hash: md5
      md5: d4444cdb7522271639b33213f4e1537a.dir
      size: 235758260
      nfiles: 934
    - path: data/08_catalog/v1.0/selection.yaml
      hash: md5
      md5: e6b92e5f9dbf6cf4e505d514a0b3a402
      size: 7074
    - path: scripts/catalog/build_catalog_from_selection.py
      hash: md5
      md5: 3140fd52f649f70a65c9d28325f22cab
      size: 4204
    - path: scripts/catalog/extract_catalog_features.py
      hash: md5
      md5: 840e9d9ae08c2f27a7ad5ec93b934a7b
      size: 8149
    - path: scripts/catalog/generate_catalog_metadata.py
      hash: md5
      md5: 61e5b57a2d299834163334f34e3e6597
      size: 13961
    outs:
    - path: data/08_catalog/v1.0/catalog_index.yaml
      hash: md5
      md5: 0dda9f61e13188539e6db2bb15f7b2c5
      size: 1541
    - path: data/08_catalog/v1.0/database
      hash: md5
      md5: a88729c4c4783bea1fb8b3e52916d33d.dir
      size: 93461689
      nfiles: 149
